---
title: "Survey Results"
output: html_notebook
---

# Evaluating Survey Results
## Setup
```{r}
rm(list = ls()) # clean workspace

library(ggplot2)
library(tidyverse)
```


## Loading the table
```{r}
file = r"(C:\Users\Valen\Documents\Git-Repositorys\TUHH\Applied Statistics\week01\Week1_Survey_Results.csv)"

# file = r"(C:\Users\Valentin\Documents\GIT_REPS\TUHH\Applied-Statistics\week01\Week1_Survey_Results.csv)"

survey <- read.csv(file, header = TRUE, sep = ",")
```


## Clean the Data
```{r}
# select all coffee drinkers and remove trailing and leading whitespaces
filtered_survey <- survey |>
  filter(Drinks.Coffee == 'Y') |>
  mutate(across(where(is.character), str_trim))



location_mapping <- c("B" = "Cafe ZessP",
                      "Cafe Zess" = "Cafe ZessP",
                      "I" = "Mensa")


# replace location B and other variants with Cafe ZessP
filtered_survey <- filtered_survey |>
  mutate(Location = case_match(Location,
                                "B" ~ "Cafe ZessP",
                                "Zess Cafe" ~ "Cafe ZessP",
                                "I" ~ "Mensa",
                                .default = Location))
  


all_semesters <- survey$Semester
semesters <- filtered_survey$Semester
locations <- filtered_survey$Location 
ratings <- filtered_survey$Rating
types <- filtered_survey$Type
reasons <-filtered_survey$Reason

```


## View the Data
### histograms
```{r}
barplot(table(survey$Drinks.Coffee))

# hist(survey$Semester, breaks = seq(0, 20, 1))
# hist(survey$Rating, breaks = seq(0, 5, 1))

barplot(table(all_semesters))
barplot(table(ratings))
barplot(table(reasons))
barplot(table(locations), cex.names = 0.6, las = 2)
```
## Analyze the data
### How are the Locations rated and visited?
```{r} 
# What too much GPT does to a script

reason_counts <- filtered_survey %>%
  group_by(Location, Reason) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(Location) %>%
  mutate(reason_percent = count / sum(count)) %>%
  ungroup()

location_summary <- filtered_survey |>
  group_by(Location, Reason) |>
  summarise(
    mean_rating = mean(Rating, na.rm = TRUE),
    mean_semester = mean(Semester, na.rm = TRUE),
    N = n(),
    .groups = "drop"
  ) |>
  arrange(desc(mean_rating))

plot_data <- location_summary %>%
  left_join(reason_counts %>% select(Location, Reason, reason_percent),
            by = c("Location", "Reason")) %>%
  mutate(segment_height = mean_rating * reason_percent)

print(plot_data)

library(forcats)
plot_data <- plot_data %>%
  mutate(Location = fct_rev(fct_reorder(Location, segment_height, .fun = sum)))


ggplot(plot_data, aes(x = Location, y = segment_height, fill = Reason)) + 
  geom_bar(stat = "identity") + 
  theme_minimal() +
  geom_text(aes(label = N),                      # use N as label
          position = position_stack(vjust = 0.5),
          size = 3,
          color = "white") + 
  scale_fill_manual(
    values = c("Q" = "#1b9e77", "C" = "#d95f02", "P" = "#7570b3"),
    labels = c("Q" = "Quality", "C" = "Convenience", "P" = "Price")
  ) +
  labs(
    title = "Mean Ratings per Location with Reasons",
    x = "Location",
    y = "Mean Rating",
    fill = "Reason in % \nwith N answers"
)
  

# not coloring the bars is significantly simpler
location_stats <- filtered_survey |> 
  group_by(Location) |>
  summarize(
    mean_rating = mean(Rating),
    mean_semester = mean(Semester),
    N = n()) |>
  arrange(desc(mean_rating))

barplot(location_stats$mean_semester,
        names.arg = location_stats$Location,
        ylab = "Mean Semester",
        main = "Mean Semester by Location",
        las = 2)





```
### How do the semesters correspond to the Students Ratings
```{r}
semester_rating <- filtered_survey |>
  group_by(Semester) |>
  summarize(mean_rating = mean(Rating), N = n(), .groups = "drop")

print(semester_rating)

ggplot(semester_rating, aes(x = Semester, y = mean_rating)) +
  geom_point(fill = "skyblue") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Mean Rating per Semester with linear trend", y = "Mean Rating", x = "Semester") +
  theme_minimal()
```
### Mean Location Rating in relation to the amount of mentions N
```{r}

```


